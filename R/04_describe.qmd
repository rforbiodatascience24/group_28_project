---
title: "04_describe"
format: html
editor: visual
---

## 

```{r}
#| output: false
library("tidyverse")
library("table1")
library("dplyr")
library("here")
```

## Describing the data

```{r}
data <- read_tsv(file = here("data/03_dat_aug.tsv.gz"), 
                 na = "NA", 
                 guess_max = 1001
                 )
```

```{r}
problems(data)
```

### Creating a table1

```{r}
data |>
  filter(!is.na(vital_status)) |>
  table1(x = formula(~ gender + ethnicity + age_group + cancer_stage | vital_status),
         data = _)

```

### Descriptive graphs

The below graph shows the amount of people for stage of cancer

```{r}
# Plot the data as percentages (sideways)
ggplot(data, aes(y = cancer_stage, fill = cancer_stage)) +
  geom_bar(stat = "count") + 
  labs(
    title = "Number of People per Cancer Stage",
    x = "Count",
    y = "Cancer Stage"
  ) +
  theme_minimal() +
  theme(axis.text.y = element_text(angle = 0, hjust = 1),
        legend.position = "none") 
```

The below graph illustrates the sexes and ethnicities of the people tested (removed NA values)

```{r}
ggplot(
  data |> 
         filter(!is.na(gender) & !is.na(ethnicity)), aes(x = gender, fill = ethnicity)) +
  
  geom_bar(position = "fill") +
    scale_fill_manual(values = c("hispanic or latino" = "lightgreen", "not hispanic or latino" = "deepskyblue3", "not reported" = "hotpink")) +
  labs(
    title = "Gender and Ethnicity Overview",
    x = "Gender",
    y = "Proportion"
  ) +
  theme_minimal()

```

The below graph shows whether therapy and treatment have any effect on days to death

```{r}

p1 <- ggplot(
  data |>
    filter(!is.na(treatment), !is.na(days_to_death), treatment != "not reported"), 
  aes(x = treatment, y = days_to_death, fill = treatment)
) +
  geom_boxplot() +
  labs(
    title = "Days to Death by Treatment",
    x = "Treatment",
    y = "Days to Death"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p2 <- ggplot(
  data |>
    filter(!is.na(therapy), !is.na(days_to_death), therapy != "not reported"), 
  aes(x = therapy, y = days_to_death, fill = therapy)
) +
  geom_boxplot() +
  labs(
    title = "Days to Death by Therapy",
    x = "Therapy",
    y = "Days to Death"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

library(patchwork)

p1/p2

```

Below shows whether therapy, treatment, both or neither have any effect on whether the patient lives or not

First we make a new data with a column specifying treatment

```{r}
combined_data <- data |>
  mutate(
    combined_category = case_when(
      therapy == "yes" & treatment == "yes" ~ "Both",
      therapy == "no" & treatment == "yes" ~ "Treatment Only",
      therapy == "yes" & treatment == "no" ~ "Therapy Only",
      therapy == "no" & treatment == "no" ~ "Neither",
      TRUE ~ NA_character_
    )
  ) |>
  filter(!is.na(combined_category), !is.na(vital_status))  # Remove NA values
```

Now we can create the actual plot

```{r}

ggplot(combined_data, aes(x = combined_category, fill = vital_status)) +
  geom_bar(position = "fill") +  # Position the bars as proportions
  scale_fill_manual(values = c("Alive" = "lightgreen", "Dead" = "maroon")) +
  labs(
    title = "Vital Status by Therapy and Treatment Combination",
    x = "Therapy and Treatment Combination",
    y = "Proportion",  # Label y-axis as Proportion
    fill = "Vital Status"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = scales::percent)  # Display y-axis as percentage
```

The below graph shows whether a given age is more likely to survive (probably could do more with this or make it fairer somehow)

```{r}

ggplot(data |> 
         filter(!is.na(age_at_diagnosis_years)), aes(x = age_at_diagnosis_years, fill = vital_status)) +
  geom_density(alpha = 0.3, position = "identity", adjust = 3) +  # adjust the smoothness
  scale_fill_manual(values = c("Alive" = "lightgreen", "Dead" = "maroon")) +
  labs(
    title = "Vital Status by Age",
    x = "Age at Diagnosis",
    y = "Density", 
    fill = "Vital Status"
  ) +
  theme_minimal()


```

Gender and ethnicity by vital status

```{r}
ggplot(data |> 
         filter(!is.na(gender) & !is.na(vital_status) & !is.na(ethnicity) & ethnicity != "not reported"),
         aes(x = ethnicity, fill = vital_status)) +
  geom_bar(position = "fill") +  # Stacked bar plot showing proportions
  scale_fill_manual(values = c("Alive" = "lightgreen", "Dead" = "maroon")) +
  facet_wrap(~ gender) +  # Create a separate plot for each gender
  labs(
    title = "Vital Status by Ethnicity and Gender",
    x = "Ethnicity",
    y = "Proportion",
    fill = "Vital Status"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for readability


```

Whether prior malignancy affects days to death (could also be a density plot I just think violin plots are cool)

```{r}
ggplot(data |> 
         filter(!is.na(prior_malignancy) & !is.na(days_to_death)), 
       aes(x = prior_malignancy, y = days_to_death, fill = prior_malignancy)) +
  geom_violin() +  # Use violin plot
  scale_fill_manual(values = c("no" = "lightgreen", "yes" = "maroon")) +
  labs(
    title = "Days to Death by Prior Malignancy",
    x = "Prior Malignancy",
    y = "Days to Death"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "none")
```

The below graph(s) show(s) the vitality for each type of cancer (but first it shortens some of the categories)

```{r}

data <- data |>
  mutate(primary_diagnosis_short = recode(primary_diagnosis,
    "Infiltrating duct carcinoma, NOS" = "Infiltrating duct",
    "Infiltrating duct mixed with other types of carcinoma" = "Infiltrating duct mixed",
    "Lobular carcinoma, NOS" = "Lobular",
    "Medullary carcinoma, NOS" = "Medullary",
    "Large cell neuroendocrine carcinoma" = "Large cell neuroendocrine",
    "Infiltrating lobular mixed with other types of carcinoma" = "Infiltrating lobular mixed",
    "Intraductal papillary adenocarcinoma with invasion" = "Intraductal papillary adeno",
    "Mucinous adenocarcinoma" = "Mucinous adeno",
    "Phyllodes tumor, malignant" = "Phyllodes tumor",
    "Paget disease and infiltrating duct carcinoma of breast" = "Paget disease and duct",
    "Apocrine adenocarcinoma" = "Apocrine adenocarcinoma",
    "Infiltrating duct and lobular carcinoma" = "Duct and lobular",
    "Secretory carcinoma of breast" = "Secretory",
    "Cribriform carcinoma, NOS" = "Cribriform",
    "Metaplastic carcinoma, NOS" = "Metaplastic",
    "Pleomorphic carcinoma" = "Pleomorphic",
    "Intraductal micropapillary carcinoma" = "Intraductal micropapillary",
    "Adenoid cystic carcinoma" = "Adenoid cystic",
    "Carcinoma, NOS" = "Carcinoma",
    "Papillary carcinoma, NOS" = "Papillary",
    "Basal cell carcinoma, NOS" = "Basal cell",
    "Tubular adenocarcinoma" = "Tubular adeno"
  ))
```

```{r}
ggplot(data |> 
      filter(!is.na(primary_diagnosis_short) & !is.na(vital_status)),
       aes(x = vital_status, fill = vital_status)) +
  geom_bar() +
  scale_fill_manual(values = c("Alive" = "lightgreen", "Dead" = "maroon")) +
  facet_wrap(~ primary_diagnosis_short, scales = "free_y") +
  theme_classic(base_size = 8) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 6, angle = 0, hjust = 0.5, vjust = 0.5)
  ) +
  scale_y_continuous(breaks = NULL) +
  labs(title = "Vital Status Distribution by Primary Diagnosis",
       x = NULL,
       y = NULL, 
       fill = NULL)

```

This can also be shown as a bar plot with proportions

```{r}
ggplot(data |> 
         filter(!is.na(primary_diagnosis) & !is.na(vital_status)),
       aes(x = primary_diagnosis, fill = vital_status)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = c("Alive" = "lightgreen", "Dead" = "maroon")) +
  theme_classic(base_size = 8) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Proportion of Vital Status by Primary Diagnosis", x = "Primary Diagnosis", y = "Proportion")


```
