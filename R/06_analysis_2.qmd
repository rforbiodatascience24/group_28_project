---
title: "06_analysis_2"
format: html
editor: visual
---

```{r}
#| output: false
library("tidyverse")
library("here")
library("broom")
library("cowplot")
```

## Performing a PCA

```{r}
data <- read_tsv(file = here("data/03_dat_aug.tsv.gz"), 
                 na = "NA", 
                 guess_max = 1001
                 )
```

### Look at the data in PC coordinates

```{r}
data_pivot <- data |>
  pivot_wider(
    names_from = ensembl_id,
    values_from = gene_expression
  )
```

```{r}
pca_fit <- data_pivot |> 
  select(starts_with("ENSG")) |> 
  select(where(~ any(. != 0))) |> 
  prcomp(scale = TRUE)
```

```{r}
pca_fit |> 
  augment(data_pivot) |> 
  filter(abs(.fittedPC1) < 50 & abs(.fittedPC2) < 50) |> 
  ggplot(aes(.fittedPC1, .fittedPC2, color = vital_status)) +
  geom_point(size = 1.5) +
  theme_half_open(12) + background_grid()
```

```{r}
pca_fit |> 
  augment(data_pivot) |> 
  filter(abs(.fittedPC1) < 50 & abs(.fittedPC2) < 50) |>
  ggplot(aes(.fittedPC1, .fittedPC2, color = prior_malignancy)) +
  geom_point(size = 1.5) +
  theme_half_open(12) + background_grid()
```

```{r}
pca_fit |> 
  augment(data_pivot) |> 
  filter(abs(.fittedPC1) < 50 & abs(.fittedPC2) < 50) |>
  ggplot(aes(.fittedPC1, .fittedPC2, color = cancer_stage)) +
  geom_point(size = 1.5) +
  theme_half_open(12) + background_grid()
```

### Look at the rotation matrix

```{r}
pca_fit |> 
  tidy(matrix = "rotation")
```

```{r}
pca_fit |> 
  tidy(matrix = "eigenvalues")
```

### Look at the variance explained by each PC
